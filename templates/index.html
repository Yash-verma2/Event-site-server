<!doctype html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8">
  <title>Birthday Page Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Load Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Configure Tailwind to use Inter font -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          }
        },
      }
    }
  </script>
  <!-- Custom CSS for a smooth scrollbar on the gift selector, updated color -->
  <style>
    .gift-options::-webkit-scrollbar {
      height: 8px;
    }
    .gift-options::-webkit-scrollbar-thumb {
      background-color: #0369a160;
      border-radius: 4px;
    }
    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }
  </style>
</head>

<body class="bg-gradient-to-br from-gray-100 to-white dark:from-gray-900 dark:to-[#070c13] min-h-screen flex justify-center items-center p-4 sm:p-8 font-sans transition-colors duration-500">

  <!-- Message/Toast Container -->
  <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <!-- Main Card Container -->
  <div class="bg-white/95 backdrop-blur-sm dark:bg-[#070c13]/70 p-6 sm:p-8 rounded-3xl shadow-2xl max-w-xl w-full text-center border border-gray-100/50 dark:border-gray-700/50 transition-colors duration-500">
    <h1 class="text-3xl font-bold mb-6 text-sky-700 dark:text-sky-400 transition-colors duration-500">Generate a Birthday Page ðŸ¥³</h1>

    <form id="birthdayForm" enctype="multipart/form-data" class="space-y-4 text-left">

      <!-- Template Selector -->
      <select id="template_selector" name="template"
        class="mt-1 w-full p-3 border border-gray-300 rounded-xl focus:border-sky-700 focus:ring-1 focus:ring-sky-700 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-300 dark:focus:border-sky-400 dark:focus:ring-sky-400 transition duration-150 text-gray-700">
        <option value="birthday.html" data-preview="templates/static/previews/birthday.png" selected>Birthday Template</option>
        <option value="anniversary.html" data-preview="/static/previews/anniversary.png">Anniversary Template</option>
        <option value="congratulations.html" data-preview="/static/previews/congratulations.png">Congratulations Template</option>
        <option value="custom.html" data-preview="/static/previews/custom.png">Custom Template</option>
      </select>

      <!-- Template Preview -->
      <div id="templatePreviewContainer" class="mt-4 p-4 border border-gray-200 dark:border-gray-700 rounded-xl bg-gray-50/50 dark:bg-gray-800/50 text-center">
        <p class="text-gray-700 dark:text-gray-300 mb-2">Template Preview:</p>
        <img id="templatePreview" src="templates//static//previews//birthday.png" alt="Template Preview" class="mx-auto max-h-48 rounded-xl shadow-lg transition-all duration-300">
      </div>

      <!-- Name and Title -->
      <div>
        <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Name of Birthday Person</label>
        <input type="text" id="name" name="name" placeholder="Shristi" required
               class="mt-1 w-full p-3 border border-gray-300 rounded-xl focus:border-sky-700 focus:ring-1 focus:ring-sky-700 dark:bg-gray-800 dark:border-gray-600 dark:text-white dark:focus:border-sky-400 dark:focus:ring-sky-400 transition duration-150">
      </div>

      <div>
        <label for="title" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Page Title</label>
        <input type="text" id="title" name="title" placeholder="Happy Birthday!"
               class="mt-1 w-full p-3 border border-gray-300 rounded-xl focus:border-sky-700 focus:ring-1 focus:ring-sky-700 dark:bg-gray-800 dark:border-gray-600 dark:text-white dark:focus:border-sky-400 dark:focus:ring-sky-400 transition duration-150">
      </div>

      <!-- Messages -->
      <div>
        <label for="messages" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Messages (one per line)</label>
        <textarea id="messages" name="messages" rows="4" placeholder="Write messages, each on a new line"
                  class="mt-1 w-full p-3 border border-gray-300 rounded-xl resize-none focus:border-sky-700 focus:ring-1 focus:ring-sky-700 dark:bg-gray-800 dark:border-gray-600 dark:text-white dark:focus:border-sky-400 dark:focus:ring-sky-400 transition duration-150"></textarea>
      </div>

      <!-- Main Image -->
      <div>
        <label for="main_image" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Main Image</label>
        <input type="file" id="main_image" name="main_image" accept="image/*" required
               class="mt-1 w-full p-3 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-sky-700/10 file:text-sky-700 hover:file:bg-sky-700/20 dark:file:bg-sky-400/10 dark:file:text-sky-400 dark:hover:file:bg-sky-400/20 transition duration-150 border border-gray-300 rounded-xl dark:border-gray-600 dark:bg-gray-800 dark:text-white">
      </div>

      <!-- Gift Options -->
      <div class="border-t pt-4 border-gray-100 dark:border-gray-700">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Gift Image (Choose or Upload)</label>
        <div class="gift-options flex space-x-4 pb-3 mb-4 overflow-x-scroll scrollbar-hide">
          <img src="templates/static/previews/Gemini_Generated_Image_jltdgjltdgjltdgj.png" alt="Gift Option 1" onclick="selectGift(this)" data-gift-path="/static/gift1.png"
               class="w-20 h-20 flex-shrink-0 object-cover cursor-pointer rounded-xl border-4 border-transparent hover:border-sky-700/50 dark:hover:border-sky-400/50 transition duration-150">
          <img src="templates/static/previews/Gemini_Generated_Image_yqya9dyqya9dyqya.png" alt="Gift Option 2" onclick="selectGift(this)" data-gift-path="/static/gift2.png"
               class="w-20 h-20 flex-shrink-0 object-cover cursor-pointer rounded-xl border-4 border-transparent hover:border-sky-700/50 dark:hover:border-sky-400/50 transition duration-150">
          <img src="https://placehold.co/80x80/0369a1/ffffff?text=Gift+3" alt="Gift Option 3" onclick="selectGift(this)" data-gift-path="/static/gift3.png"
               class="w-20 h-20 flex-shrink-0 object-cover cursor-pointer rounded-xl border-4 border-transparent hover:border-sky-700/50 dark:hover:border-sky-400/50 transition duration-150">
          <img src="https://placehold.co/80x80/0369a1/ffffff?text=Gift+4" alt="Gift Option 4" onclick="selectGift(this)" data-gift-path="/static/gift4.png"
               class="w-20 h-20 flex-shrink-0 object-cover cursor-pointer rounded-xl border-4 border-transparent hover:border-sky-700/50 dark:hover:border-sky-400/50 transition duration-150">
          <img src="https://placehold.co/80x80/0369a1/ffffff?text=Gift+5" alt="Gift Option 5" onclick="selectGift(this)" data-gift-path="/static/gift5.png"
               class="w-20 h-20 flex-shrink-0 object-cover cursor-pointer rounded-xl border-4 border-transparent hover:border-sky-700/50 dark:hover:border-sky-400/50 transition duration-150">
        </div>
        
        <input type="hidden" name="gift_image_selected" id="gift_image_selected">
        
        <label for="gift_image_upload" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mt-4">Or upload your own Gift Image (optional)</label>
        <input type="file" name="gift_image" id="gift_image_upload" accept="image/*"
               class="w-full p-3 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-sky-700/10 file:text-sky-700 hover:file:bg-sky-700/20 dark:file:bg-sky-400/10 dark:file:text-sky-400 dark:hover:file:bg-sky-400/20 transition duration-150 border border-gray-300 rounded-xl dark:border-gray-600 dark:bg-gray-800 dark:text-white">
      </div>

      <!-- Music Options -->
      <div class="border-t pt-4 border-gray-100 dark:border-gray-700">
        <label for="music_selector" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Background Music (Choose Track)</label>
        
        <select id="music_selector" name="music_option" 
          class="mt-1 w-full p-3 border border-gray-300 rounded-xl focus:border-sky-700 focus:ring-1 focus:ring-sky-700 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-300 dark:focus:border-sky-400 dark:focus:ring-sky-400 transition duration-150 text-gray-700">
          <option value="" selected>-- Select a pre-set music track --</option>
          <option value="templates//static//music//happy-birthday-138622.mp3">Track 1 - Happy Pop</option>
          <option value="templates//static//music//happy-birthday-254480.mp3">Track 2 - Gentle Waltz</option>
          <option value="/static/music/music3.mp3">Track 3 - Electronic Beat</option>
          <option value="/static/music/music4.mp3">Track 4 - Classic Ballad</option>
          <option value="/static/music/music5.mp3">Track 5 - Upbeat Ukulele</option>
        </select>

        <input type="hidden" name="music_selected" id="music_selected" value="">

        <!-- Music Preview Player -->
        <audio id="music_preview" controls class="mt-3 hidden w-full">
          <source id="music_preview_source" src="" type="audio/mpeg">
          Your browser does not support the audio element.
        </audio>

        <label for="music_upload" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mt-4">Or upload your own Music File (optional)</label>
        <input type="file" name="music" id="music_upload" accept="audio/*"
               class="w-full p-3 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-sky-700/10 file:text-sky-700 hover:file:bg-sky-700/20 dark:file:bg-sky-400/10 dark:file:text-sky-400 dark:hover:file:bg-sky-400/20 transition duration-150 border border-gray-300 rounded-xl dark:border-gray-600 dark:bg-gray-800 dark:text-white">
      </div>

      <!-- Gallery Images -->
      <div class="border-t pt-4 border-gray-100 dark:border-gray-700">
        <label for="gallery" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Gallery Images (up to 8)</label>
        <input type="file" id="gallery" name="gallery" accept="image/*" multiple
               class="mt-1 w-full p-3 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-sky-700/10 file:text-sky-700 hover:file:bg-sky-700/20 dark:file:bg-sky-400/10 dark:file:text-sky-400 dark:hover:file:bg-sky-400/20 transition duration-150 border border-gray-300 rounded-xl dark:border-gray-600 dark:bg-gray-800 dark:text-white">
      </div>

      <button type="submit" class="w-full py-3 bg-sky-700 text-white text-lg font-semibold rounded-xl hover:bg-sky-800 dark:bg-sky-500 dark:hover:bg-sky-400 transition duration-300 shadow-md hover:shadow-lg mt-6">
        ðŸš€ Generate Page
      </button>
    </form>

    <!-- Generated Link Section -->
    <div id="generatedLinkContainer" class="hidden mt-8 p-4 bg-gray-50/50 dark:bg-gray-800/50 rounded-xl border border-gray-200 dark:border-gray-700">
      <p class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-3">Your birthday page is ready! ðŸŽ‰</p>
      <input type="text" id="generatedLink" readonly
             class="w-full p-3 border border-gray-300 rounded-lg text-center bg-white dark:bg-gray-700 mb-4 text-gray-600 dark:text-gray-300 font-mono text-sm select-all cursor-text">
      <button class="w-full py-3 bg-emerald-600 text-white text-base font-semibold rounded-xl hover:bg-emerald-700 transition duration-300" onclick="visitPage()">
        View Page
      </button>
    </div>

    <div class="mt-8 pt-6 border-t border-gray-100 dark:border-gray-700">
      <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Share your page link easily:</p>
      <div class="share-buttons flex justify-center space-x-4 flex-wrap gap-3">
        <button class="px-5 py-3 rounded-xl text-white font-medium transition duration-200 bg-sky-700 hover:bg-sky-800 dark:bg-sky-500 dark:hover:bg-sky-400 shadow-md" onclick="copyLink()">
          Copy Link
        </button>
        <button class="px-5 py-3 rounded-xl text-white font-medium transition duration-200 bg-[#25D366] hover:bg-[#128C7E]" onclick="shareWhatsApp()">
          WhatsApp
        </button>
        <button class="px-5 py-3 rounded-xl text-white font-medium transition duration-200 bg-[#4267B2] hover:bg-[#365899]" onclick="shareFacebook()">
          Facebook
        </button>
        <button class="px-5 py-3 rounded-xl text-white font-medium transition duration-200 bg-[#1DA1F2] hover:bg-[#0c85d0]" onclick="shareTwitter()">
          X / Twitter
        </button>
        <button class="px-5 py-3 rounded-xl text-white font-medium transition duration-200 bg-violet-600 hover:bg-violet-700" onclick="sharePage()">
          Share (Instagram, etc.)
        </button>
      </div>
    </div>
  </div>

  <script>
    // Template Preview
    const templateSelector = document.getElementById('template_selector');
    const templatePreview = document.getElementById('templatePreview');

    templateSelector.addEventListener('change', () => {
      const selectedOption = templateSelector.selectedOptions[0];
      const previewSrc = selectedOption.getAttribute('data-preview');
      if(previewSrc) {
        templatePreview.src = previewSrc;
      }
    });

    // Music Preview with Error Handling
    document.getElementById("music_selector").addEventListener("change", function () {
      const audio = document.getElementById("music_preview");
      const source = document.getElementById("music_preview_source");
      const selected = this.value;

      console.log("Music selector changed to:", selected);

      if (selected) {
        source.src = selected;
        audio.classList.remove("hidden");
        
        // Reset and load
        audio.pause();
        audio.currentTime = 0;
        audio.load();
        
        // Try to play with error handling
        const playAudio = async () => {
          try {
            await audio.play();
            console.log("Preview playing successfully");
          } catch (error) {
            console.log("Preview play failed (normal for some browsers):", error);
            showToast("Click the play button to preview the music", false);
          }
        };
        
        playAudio();
        
        // Store selection
        document.getElementById("music_selected").value = selected;
        document.getElementById("music_upload").value = "";
      } else {
        audio.pause();
        audio.classList.add("hidden");
        document.getElementById("music_selected").value = "";
      }
    });

    // Uploaded Music Preview
    document.getElementById("music_upload").addEventListener("change", function () {
      const file = this.files[0];
      const audio = document.getElementById("music_preview");
      const source = document.getElementById("music_preview_source");

      console.log("Music upload changed:", file ? file.name : "None");

      if (file) {
        const url = URL.createObjectURL(file);
        source.src = url;
        audio.classList.remove("hidden");
        
        audio.pause();
        audio.currentTime = 0;
        audio.load();
        
        const playAudio = async () => {
          try {
            await audio.play();
            console.log("Upload preview playing successfully");
          } catch (error) {
            console.log("Upload preview play failed:", error);
            showToast("Click the play button to preview your uploaded music", false);
          }
        };
        
        playAudio();

        // Clear preset selection
        document.getElementById("music_selector").value = "";
        document.getElementById("music_selected").value = "";
      } else {
        audio.pause();
        audio.classList.add("hidden");
      }
    });

    // Toast Notification
    function showToast(message, isError = false) {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      
      const bgColor = isError ? 'bg-amber-500 dark:bg-amber-400' : 'bg-emerald-600 dark:bg-emerald-400';
      const title = isError ? 'Error' : 'Success';

      toast.className = `${bgColor} text-white px-4 py-3 rounded-xl shadow-lg transition duration-300 transform translate-x-full opacity-0 max-w-xs`;
      toast.innerHTML = `<div class="font-semibold">${title}</div><div>${message}</div>`;

      container.appendChild(toast);

      setTimeout(() => {
        toast.classList.remove('translate-x-full', 'opacity-0');
        toast.classList.add('translate-x-0', 'opacity-100');
      }, 10);

      setTimeout(() => {
        toast.classList.remove('translate-x-0', 'opacity-100');
        toast.classList.add('translate-x-full', 'opacity-0');
        setTimeout(() => {
          container.removeChild(toast);
        }, 300);
      }, 4000);
    }

    // Gift Selection
    function selectGift(img) {
      const selectedPath = img.getAttribute('data-gift-path');

      document.querySelectorAll('.gift-options img').forEach(i => i.classList.remove('border-sky-700', 'dark:border-sky-400', 'shadow-lg'));
      
      img.classList.add('border-sky-700', 'dark:border-sky-400', 'shadow-lg');
      
      document.getElementById('gift_image_selected').value = selectedPath;
      document.getElementById('gift_image_upload').value = '';
    }

    // Form Submission with Better Error Handling
    document.getElementById('birthdayForm').addEventListener('submit', function(e){
      e.preventDefault();
      const formData = new FormData(this);
      
      // Debug: Log form data
      console.log("=== Form Data ===");
      for (let [key, value] of formData.entries()) {
        console.log(key + ": " + value);
      }

      showToast("Generating page...", false);

      // Use relative path for production
      fetch("/generate", {
        method: "POST",
        body: formData,
        headers: {'X-Requested-With': 'XMLHttpRequest'}
      })
      .then(res => {
        if (!res.ok) {
          throw new Error(`Server responded with ${res.status}`);
        }
        return res.json();
      })
      .then(data => {
        if (data.error) {
          throw new Error(data.error);
        }
        document.getElementById('generatedLink').value = data.link;
        document.getElementById('generatedLinkContainer').style.display = "block";
        showToast("Page generated successfully!", false);
      })
      .catch(err => {
        console.error('Fetch error:', err);
        showToast("Error generating page: " + err.message, true);
      });
    });

    // Utility Functions
    function visitPage() {
      const link = document.getElementById('generatedLink').value;
      if(link) window.open(link, "_blank");
    }

    function getGeneratedLink() {
      return document.getElementById('generatedLink').value || "";
    }

    function shareWhatsApp() {
      const link = getGeneratedLink();
      if(link) window.open(`https://wa.me/?text=${encodeURIComponent("Check out this birthday page: " + link)}`, '_blank');
      else showToast("Please generate a link first.", true);
    }

    function shareTwitter() {
      const link = getGeneratedLink();
      if(link) window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent("Check out this birthday page: " + link)}`, '_blank');
      else showToast("Please generate a link first.", true);
    }
    
    function shareFacebook() {
      const link = getGeneratedLink();
      const title = document.getElementById('title').value || "A New Birthday Page";
      if(link) window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}&quote=${encodeURIComponent(`Check out this fun birthday page: ${title}!`)}`, '_blank');
      else showToast("Please generate a link first.", true);
    }

    async function sharePage() {
      const link = getGeneratedLink();
      const title = document.getElementById('title').value || "Birthday Page";
      if (!link) {
        showToast("Please generate a link first.", true);
        return;
      }

      if (navigator.share) {
        try {
          await navigator.share({
            title: title,
            text: `Check out this birthday page for ${document.getElementById('name').value}!`,
            url: link
          });
        } catch (error) {
          if (error.name !== 'AbortError') {
            showToast("Could not initiate native share. Copying link instead.", true);
            copyLink();
          }
        }
      } else {
        showToast("Native share not supported. The link has been copied for manual sharing.", true);
        copyLink();
      }
    }

    function copyLink() {
      const link = getGeneratedLink();
      if(link) {
        if (navigator.clipboard) {
          navigator.clipboard.writeText(link).then(() => {
            showToast("Link copied to clipboard!");
          }).catch(err => {
            const linkInput = document.getElementById('generatedLink');
            linkInput.select();
            document.execCommand('copy');
            showToast("Link copied to clipboard (using fallback)!");
          });
        } else {
          const linkInput = document.getElementById('generatedLink');
          linkInput.select();
          document.execCommand('copy');
          showToast("Link copied to clipboard (using fallback)!");
        }
      } else {
        showToast("Please generate a link first.", true);
      }
    }

    // Set default gift selection on load
    document.addEventListener('DOMContentLoaded', () => {
      const defaultGift = document.querySelector('.gift-options img:first-child');
      if (defaultGift) {
        selectGift(defaultGift);
      }
    });
  </script>
</body>
</html>