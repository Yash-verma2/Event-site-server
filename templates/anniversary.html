<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} | Our Shared Light</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom config for romantic colors and Inter font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400..700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden; /* Prevent horizontal scroll from background */
            /* Added minimal horizontal padding to prevent content from hugging screen edges */
            padding-left: 0.5rem; 
            padding-right: 0.5rem;
        }

        /* 1. Unforgettable Background: Starlight Effect */
        .starlight-bg {
            background-color: #1a0033; /* Deep dark purple/blue */
            background-image: radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 40px),
                              radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 30px),
                              radial-gradient(white, rgba(255,255,255,.1) 3px, transparent 40px);
            background-size: 550px 550px, 350px 350px, 250px 250px;
            background-position: 0 0, 40px 60px, 130px 270px;
            animation: move-stars 100s linear infinite;
        }

        @keyframes move-stars {
            from { background-position: 0 0, 40px 60px, 130px 270px; }
            to { background-position: 550px 550px, 390px 410px, 380px 720px; }
        }

        /* 2. Enhanced Animations */
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }
        .heartbeat {
            animation: heartbeat 2s ease-in-out infinite;
            text-shadow: 0 0 12px rgba(255, 105, 180, 0.9);
        }
        
        /* NEW: Pulsing Text for Infinite Connection */
        @keyframes pulse-light {
            0%, 100% { opacity: 1; text-shadow: 0 0 10px rgba(255, 192, 203, 0.8); }
            50% { opacity: 0.8; text-shadow: 0 0 20px rgba(255, 255, 255, 0.6); }
        }
        .pulsing-text {
            animation: pulse-light 3s ease-in-out infinite;
        }

        .gift-box:hover {
            transform: scale(1.1) rotate(-2deg);
            box-shadow: 0 15px 30px rgba(255, 87, 128, 0.8);
        }
        
        /* Typewriter effect styles - FIX for responsiveness */
        .typewriter-text {
            overflow: hidden;
            border-right: .15em solid white; 
            /* REMOVED: white-space: nowrap; to allow wrapping */
            margin: 0 auto;
            letter-spacing: .08em; /* Reduced spacing slightly to help fit */
            animation: blink-caret .75s step-end infinite;
            width: 0; /* JS controls width */
            text-align: center; /* Center text across multiple lines */
            white-space: normal; /* Allow text to wrap naturally */
        }
        
        /* New rule to control the maximum visible width of the typewriter container */
        .typewriter-container {
            width: 90%; /* Limit container width to ensure it fits mobile screen */
            max-width: 40rem; /* Same as max-w-lg or similar for desktop */
            margin: 0 auto;
        }

        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: white; }
        }
        /* Ensure audio controls are visible against dark background */
        audio {
            /* Use a simple filter invert for default controls on dark bg */
            filter: brightness(0.8) sepia(1) hue-rotate(200deg) saturate(3); 
        }

        /* 3. Starlight Confetti CSS */
        .confetti {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: 10;
        }
        .confetti-particle {
            position: absolute;
            color: #ffcccc; /* Soft pink/white hearts */
            font-size: 1.5rem;
            animation: float-up 12s linear infinite;
            opacity: 0;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }
        @keyframes float-up {
            0% { transform: translateY(100vh) scale(0.5); opacity: 0; }
            10% { opacity: 0.7; }
            90% { opacity: 0.7; }
            100% { transform: translateY(-10vh) scale(1.2); opacity: 0; }
        }

        /* üåü R-E-S-P-O-N-S-I-V-E Improvements üåü */
        
        /* 1. Ultra-Small Mobile (<= 480px) */
        @media (max-width: 480px) { 
            .h1-responsive {
                font-size: 2.5rem; /* 40px - safer size for title on tiny screens */
                line-height: 1.1; 
            }
            .h2-responsive {
                font-size: 1.75rem; /* 28px */
            }
            .infinite-responsive {
                font-size: 2.25rem; /* 36px */
            }
            .main-content-padding {
                padding: 1.5rem; /* p-6 equivalent for minimal padding */
            }
            .max-w-4xl {
                max-width: 100%; /* Allow content to use full width to prevent overflow */
            }
        }
        
        /* 2. Standard Mobile (481px to 640px) */
        @media (min-width: 481px) and (max-width: 640px) {
            .h1-responsive {
                font-size: 3rem; /* 48px - standard mobile size */
            }
            .h2-responsive {
                font-size: 2rem; /* 32px */
            }
            .infinite-responsive {
                font-size: 2.5rem; /* 40px */
            }
            .main-content-padding {
                padding: 2rem; /* p-8 for better, airy mobile padding */
            }
            .max-w-4xl {
                max-width: 95%; 
            }
        }
        
        /* Desktop/Tablet (>= 641px) */
        @media (min-width: 641px) {
            .main-content-padding {
                padding: 4rem; /* Generous p-16 for desktop */
            }
            .max-w-4xl {
                max-width: 48rem; /* Use Tailwind's standard max-w-4xl width */
            }
        }
        
        /* PREMIUM CARD STYLING */
        .premium-card {
            transition: all 0.5s ease;
            /* Subtle pink glow for depth */
            box-shadow: 0 0 40px rgba(255, 105, 180, 0.4), 0 0 15px rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 105, 180, 0.6); /* Defined border for structure */
        }

        .premium-card:hover {
            /* Deeper glow on hover */
            box-shadow: 0 0 60px rgba(255, 105, 180, 0.7), 0 0 25px rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="starlight-bg min-h-screen flex flex-col items-center py-4 sm:py-10 px-2 sm:px-4 text-white">

    <div id="confetti-overlay" class="confetti"></div>

    <!-- Background Music Player -->
    <audio id="background-music" loop 
        class="hidden"
        title="Our Anniversary Music"
    >
        <source src="{{ music }}" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>
    
    <!-- Visible Audio Controls (for user interaction) -->
    <div id="audio-controls-visible" class="fixed top-4 right-4 z-50 hidden">
         <audio controls loop 
             class="w-36 sm:w-48 p-2 rounded-xl shadow-md border border-pink-400/20 transition duration-300"
             title="Our Anniversary Music"
             src="{{ music }}"
             ></audio>
    </div>

    <!-- Welcome Overlay -->
    <div id="welcome-overlay" class="fixed inset-0 bg-black bg-opacity-95 flex flex-col items-center justify-center z-50 transition-opacity duration-700 p-4">
        <h2 class="text-4xl sm:text-6xl font-extrabold text-pink-400 mb-6 heartbeat font-['Dancing_Script'] text-center">For the One Who Shares the Journey</h2>
        <p class="text-lg sm:text-xl text-gray-300 mb-10 text-center">Click below to begin our moment and start the music.</p>
        <button onclick="startExperience()" class="px-8 sm:px-12 py-4 sm:py-5 bg-yellow-400 text-purple-900 font-black text-xl sm:text-2xl rounded-full shadow-2xl shadow-yellow-400/50 hover:bg-yellow-500 transition duration-300 transform hover:scale-110 focus:outline-none focus:ring-4 focus:ring-yellow-300">
            ‚ñ∂Ô∏è Enter Our Moment
        </button>
    </div>

    <!-- Main Content Container: Added premium-card class -->
    <div id="main-content" class="w-full max-w-4xl bg-white bg-opacity-10 backdrop-blur-sm main-content-padding rounded-3xl premium-card">
        
        <div class="text-center mb-10">
            <h1 class="text-5xl h1-responsive sm:text-7xl font-extrabold text-pink-400 mb-4 heartbeat font-['Dancing_Script']">
                ‚ú® Celebrating Us, {{ name }}! ‚ú®
            </h1>
            
            <!-- Typewriter Container added for boundary control -->
            <div class="typewriter-container">
                <p id="typewriter-line" class="typewriter-text text-xl md:text-2xl text-white font-medium mx-auto mt-4 w-full"></p>
            </div>
            
            <div class="mt-8 p-4 bg-pink-600/30 rounded-xl inline-block shadow-lg border border-pink-400/50">
                <p class="text-lg sm:text-xl font-semibold mb-3 text-yellow-300">The Depth of Our Connection is...</p>
                <p id="infinite-message" class="text-5xl infinite-responsive sm:text-6xl text-pink-400 font-extrabold tracking-widest pulsing-text">
                    ‚àû INFINITE ‚àû
                </p>
                <p class="text-base sm:text-lg text-gray-300 mt-2">...A bond created in every shared moment.</p>
            </div>
        </div>

        <div id="mainImageContainer" class="w-full max-w-xl max-w-full mx-auto mb-10">
            <img 
                src="{{ main_image }}" 
                onerror="this.onerror=null;this.src='https://placehold.co/600x400/8b5cf6/ffffff?text=Our+Special+Photo'" 
                alt="Main Image" 
                class="w-full h-auto object-cover rounded-3xl shadow-purple-600/50 shadow-xl transition duration-500 hover:shadow-2xl hover:scale-[1.02] border-4 border-white/50"
            >
            </div>

        <h2 class="text-3xl h2-responsive sm:text-4xl font-bold text-pink-300 mb-6 mt-10">Sweet Messages:</h2>
        <!-- Dynamic Messages Container -->
        <div class="w-full bg-white/10 p-6 md:p-8 rounded-2xl shadow-inner border border-pink-400/20">
            <div id="messages-container" class="font-serif italic text-gray-200 space-y-4">
                <!-- Messages fetched from the server context will be dynamically rendered here. -->
            </div>
        </div>
        
        <h2 class="text-3xl h2-responsive sm:text-4xl font-bold text-pink-300 mt-12 mb-6">Your Eternal Gift Awaits!</h2>
        <div id="gift-wrapper" class="relative group cursor-pointer transition transform duration-500 gift-box mx-auto w-fit" onclick="openGift()">
            <img 
                id="gift-image"
                src="{{ gift_image }}" 
                onerror="this.onerror=null;this.src='https://placehold.co/200x200/ffbb33/1a0033?text=CLICK+TO+OPEN'" 
                alt="Gift Image" 
                class="w-36 h-36 sm:w-48 sm:h-48 object-cover rounded-full shadow-2xl transition duration-500 border-8 border-yellow-300/80"
            >
            <div id="gift-overlay" class="absolute inset-0 flex items-center justify-center bg-pink-700 bg-opacity-80 rounded-full transition-opacity duration-700 opacity-100 group-hover:opacity-0">
                <svg class="w-12 h-12 sm:w-16 sm:h-16 text-white animate-pulse" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                </svg>
            </div>
        </div>
        
        <div class="mt-12 w-full max-w-lg mx-auto text-center space-y-6">
            <h3 class="text-xl sm:text-2xl font-semibold text-pink-300 mt-8">Precious Memories:</h3>
            <a href="{{ gallery_link }}" 
               class="inline-block px-8 py-3 sm:px-10 sm:py-4 bg-yellow-400 text-purple-900 font-black text-lg sm:text-xl rounded-full shadow-2xl shadow-yellow-400/50 hover:bg-yellow-500 transition duration-300 transform hover:scale-105 hover:shadow-yellow-500/70 focus:outline-none focus:ring-4 focus:ring-yellow-300"
            >
                üåå Dive into Our Gallery Memories
            </a>
        </div>

    </div> 
    
    <script>
        // --- Dynamic Data Fetch from Server Context ---
        let msgs;
        try {
            // Using the requested server-side template syntax to fetch messages as a JSON array.
            const messagesString = `{{ messages|tojson }}`; 
            
            // Check if the template variable was successfully rendered as JSON
            if (messagesString && messagesString.startsWith('[')) {
                msgs = JSON.parse(messagesString);
            } else {
                // Fallback: Use mock messages if the server context is not available or empty
                msgs = [
                    "Every moment shared with you is a treasure I hold close to my heart.",
                    "Thank you for being the most incredible part of my life's story, my love.",
                    "Our journey together is my greatest adventure and my favorite destination."
                ];
                console.warn("Could not load messages from server context. Using mock data for demonstration.");
            }
        } catch (e) {
            console.error("Failed to parse messages from server context. Using mock data.", e);
            msgs = [
                "The universe brought us together, and I'm eternally grateful.",
                "To my soulmate, my best friend, my forever love."
            ];
        }


        // --- New Message Rendering Logic ---
        function renderMessages(messages) {
            const container = document.getElementById('messages-container');
            if (!container || !Array.isArray(messages) || messages.length === 0) {
                 if (container) {
                    container.innerHTML = '<p class="text-base sm:text-lg leading-relaxed text-gray-400">No messages found. A new chapter awaits our words!</p>';
                 }
                 return;
            }

            container.innerHTML = ''; // Clear existing content

            messages.forEach((msg, index) => {
                const p = document.createElement('p');
                p.classList.add(
                    'text-base', 'sm:text-lg', 'leading-relaxed', 
                    'border-b', 'border-pink-400/20', 'pb-3'
                );
                
                // Remove the border for the last element
                if (index === messages.length - 1) {
                    p.classList.remove('border-b', 'pb-3');
                }

                p.textContent = msg;
                container.appendChild(p);
            });
        }

        // --- 0. Setup and Start Experience ---
        function startExperience() {
            const welcomeOverlay = document.getElementById('welcome-overlay');
            const music = document.getElementById('background-music');
            const controls = document.getElementById('audio-controls-visible');

            // 1. Fade out the overlay
            welcomeOverlay.style.opacity = '0';
            setTimeout(() => welcomeOverlay.remove(), 700);

            // 2. Start the music (must be triggered by user action)
            music.play().catch(error => {
                console.error("Autoplay prevented:", error);
                // If it fails, show the controls so user can manually play
                controls.classList.remove('hidden');
            });
            controls.classList.remove('hidden');

            // 3. Start all dynamic content
            startDynamicContent();
        }

        // --- 1. Typewriter Effect Logic ---
        function typeWriterEffect(elementId, text, speed = 100) {
            let i = 0;
            const element = document.getElementById(elementId);
            if (!element) return;
            
            // Since we removed 'white-space: nowrap', the typewriter logic changes slightly.
            // We now reveal the text by slicing the full message and applying it to innerHTML,
            // allowing the browser to wrap it normally inside its container.
            
            function type() {
                if (i < text.length) {
                    // Update the text content with one more character
                    element.innerHTML = text.substring(0, i + 1);
                    i++;
                    setTimeout(type, speed);
                } else {
                    element.style.borderRight = 'none';
                }
            }
            element.innerHTML = ''; // Start empty
            type();
        }

        function startDynamicContent() {
            // UNIVERSAL TYPEWRITER: Focus on future growth
            // The text itself is short, but the new structure prevents overflow even if it were longer.
            typeWriterEffect('typewriter-line', 'The best chapters of our shared story start now...');
            createConfettiParticles();
            // NEW: Render the fetched messages
            renderMessages(msgs);
        }
        
        // --- 3. Gift Opening Modal Logic ---
        function openGift() {
            const giftWrapper = document.getElementById('gift-wrapper');
            const giftOverlay = document.getElementById('gift-overlay');

            // Hide the overlay
            if (giftOverlay) {
                giftOverlay.style.opacity = '0';
            }

            // Simple visual effect after click
            if (giftWrapper) {
                giftWrapper.classList.remove('animate-bounce'); 
                // Note: animate-spin-once keyframe is defined in the script below
                giftWrapper.classList.add('animate-spin-once'); 
                setTimeout(() => giftWrapper.classList.remove('animate-spin-once'), 1000);
            }
            
            // Show a simple message box instead of alert()
            const messageBox = document.createElement('div');
            messageBox.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4" onclick="this.remove()">
                    <div class="bg-white p-6 sm:p-10 rounded-2xl shadow-3xl text-center max-w-sm sm:max-w-md transform transition-all duration-300 scale-100 hover:scale-[1.02]" onclick="event.stopPropagation()">
                        <p class="text-3xl sm:text-4xl mb-4 text-purple-700 font-extrabold font-['Dancing_Script']">‚ú® A Note of Gratitude! ‚ú®</p>
                        <p class="text-lg sm:text-xl text-gray-800 leading-relaxed">
                            The greatest gift is the journey we share. Thank you for your light, your strength, and every unforgettable moment.
                        </p>
                        <button onclick="this.closest('.fixed').remove()" class="mt-8 px-8 py-3 bg-purple-500 text-white font-bold rounded-full hover:bg-purple-600 transition duration-300 shadow-lg">Close & Continue</button>
                    </div>
                </div>
            `;
            document.body.appendChild(messageBox);
        }

        // --- 4. Confetti Creation Logic ---
        function createConfettiParticles() {
            const container = document.getElementById('confetti-overlay');
            const emojis = ['üíñ', '‚ú®', '‚≠ê', '‚ù§Ô∏è'];
            const numberOfParticles = 30;

            for (let i = 0; i < numberOfParticles; i++) {
                const particle = document.createElement('div');
                particle.classList.add('confetti-particle');
                
                // Randomize emoji, position, delay, and duration
                particle.innerHTML = emojis[Math.floor(Math.random() * emojis.length)];
                particle.style.left = `${Math.random() * 100}vw`;
                particle.style.animationDelay = `${Math.random() * 10}s`;
                particle.style.animationDuration = `${10 + Math.random() * 5}s`;
                
                container.appendChild(particle);
            }
        }

        // Keyframes for JS Animation 
        // This ensures the custom spin works for the gift box.
        const styleSheet = document.createElement("style");
        styleSheet.type = "text/css";
        styleSheet.innerText += `@keyframes spin-once {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }`;
        document.head.appendChild(styleSheet);
    </script>
    
</body>
</html>